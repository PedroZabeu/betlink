# BetLink - Dados CrÃ­ticos de SincronizaÃ§Ã£o

## ğŸ”„ InformaÃ§Ãµes que Aparecem em MÃºltiplas PÃ¡ginas

### 1. ğŸ“Š **ROI e MÃ©tricas de Performance**

#### **DADOS SINCRONIZADOS:**
- ROI 30 dias (%)
- Total de apostas
- Unidades lucradas
- Taxa de acerto

#### **ONDE APARECEM:**
```mermaid
graph TD
    A[ROI Canal X] --> B[Ãrea PÃºblica - /canais]
    A --> C[Ãrea PÃºblica - /canal/id]
    A --> D[Tipster - /meus-canais]
    A --> E[Tipster - /canal/apostas]
    A --> F[Admin - /admin/canais]
    A --> G[Admin - /admin/dashboard]
```

**PÃ¡ginas Afetadas:**
- **PÃºblica**: `/canais` (cards dos canais)
- **PÃºblica**: `/canal/[id]` (mÃ©tricas do canal)
- **Tipster**: `/meus-canais` (cards dos canais)
- **Tipster**: `/[canal]/apostas` (cards resumo)
- **Admin**: `/admin/canais` (tabela global)
- **Admin**: `/admin/dashboard` (estatÃ­sticas)
- **Admin**: `/admin/relatorios` (grÃ¡ficos)

**PONTO CRÃTICO:**
```tsx
// PROBLEMA: ROI pode estar diferente em cada tela
// Tipster muda status de aposta â†’ ROI recalcula
// Mas pode nÃ£o atualizar em todas as telas ao mesmo tempo

// SOLUÃ‡ÃƒO: View centralizada canal_stats
SELECT roi_percentage FROM canal_stats WHERE id = canal_id;
```

---

### 2. ğŸ‘¥ **Status e Quantidade de Assinantes**

#### **DADOS SINCRONIZADOS:**
- NÃºmero de assinantes ativos
- Vagas disponÃ­veis (max - ativos)
- Lista de espera
- Status individual das assinaturas

#### **ONDE APARECEM:**
```mermaid
graph TD
    A[Assinantes Canal X] --> B[PÃºblica - /canais]
    A --> C[PÃºblica - /canal/id]
    A --> D[Cliente - /dashboard]
    A --> E[Tipster - /canal/clientes]
    A --> F[Admin - /admin/canais]
    A --> G[Admin - /admin/clientes]
```

**PÃ¡ginas Afetadas:**
- **PÃºblica**: `/canais` (badge "X vagas restantes")
- **PÃºblica**: `/canal/[id]` ("15/20 assinantes")
- **Cliente**: `/dashboard` (status da prÃ³pria assinatura)
- **Tipster**: `/[canal]/clientes` (lista completa + cards resumo)
- **Admin**: `/admin/canais` (total assinantes por canal)
- **Admin**: `/admin/clientes` (status global)

**CENÃRIO CRÃTICO:**
```tsx
// Cliente cancela assinatura
// âŒ FALHA: Ãrea pÃºblica ainda mostra "Canal Lotado"
// âŒ FALHA: Tipster nÃ£o vÃª que cliente saiu
// âŒ FALHA: Lista de espera nÃ£o Ã© processada

// âœ… SOLUÃ‡ÃƒO: Trigger automÃ¡tico
UPDATE canal_stats SET assinantes_ativos = COUNT(*)
FROM assinaturas WHERE status = 'ativa' AND canal_id = X;
```

---

### 3. ğŸ’° **PreÃ§os e Receita**

#### **DADOS SINCRONIZADOS:**
- PreÃ§o mensal do canal
- Receita total (MRR)
- ComissÃ£o da plataforma
- Valor pago por cliente

#### **ONDE APARECEM:**
```mermaid
graph TD
    A[PreÃ§o Canal X] --> B[PÃºblica - /canais]
    A --> C[PÃºblica - /canal/id]
    A --> D[Cliente - /dashboard]
    A --> E[Tipster - /canal/clientes]
    A --> F[Admin - financeiro]
```

**CENÃRIO CRÃTICO:**
```tsx
// Admin muda preÃ§o de R$ 50 â†’ R$ 60
// âŒ Ãrea pÃºblica ainda mostra R$ 50
// âŒ Assinaturas ativas continuam pagando R$ 50
// âŒ Novos clientes veem preÃ§os diferentes

// âœ… SOLUÃ‡ÃƒO: Separar preÃ§o atual vs preÃ§o pago
canais.preco_mensal (novo valor)
assinaturas.preco_pago (valor que cliente paga)
```

---

### 4. ğŸ“… **Datas de Vencimento e Status**

#### **DADOS SINCRONIZADOS:**
- Data de vencimento da assinatura
- Status (Ativo/Vencendo/Vencido/PerÃ­odo GraÃ§a)
- PrÃ³xima cobranÃ§a

#### **ONDE APARECEM:**
- **Cliente**: `/dashboard` (tabela de canais)
- **Tipster**: `/[canal]/clientes` (status de cada cliente)
- **Admin**: `/admin/clientes` (visÃ£o global)
- **Telegram**: Acesso ao canal (automÃ¡tico)

**CENÃRIO CRÃTICO:**
```tsx
// Data de vencimento passa
// âŒ Cliente ainda tem acesso no Telegram
// âŒ Dashboard mostra "Ativo" mas estÃ¡ vencido
// âŒ Tipster nÃ£o sabe que cliente estÃ¡ inadimplente

// âœ… SOLUÃ‡ÃƒO: Job diÃ¡rio + cÃ¡lculo automÃ¡tico
// Trigger atualiza status baseado em data_vencimento
// Webhook remove do Telegram automaticamente
```

---

### 5. ğŸ¯ **Dados das Apostas**

#### **DADOS SINCRONIZADOS:**
- Status das apostas (Open/Green/Red)
- Lucro calculado
- Stake total
- HistÃ³rico completo

#### **ONDE APARECEM:**
- **Tipster**: `/[canal]/apostas` (tabela + grÃ¡ficos)
- **Cliente**: Acesso via Telegram (se assinante)
- **Admin**: `/admin/relatorios` (performance global)

**CENÃRIO CRÃTICO:**
```tsx
// Tipster muda aposta de Open â†’ Green
// âŒ ROI nÃ£o recalcula automaticamente
// âŒ GrÃ¡fico acumulado nÃ£o atualiza
// âŒ MÃ©tricas do canal ficam desatualizadas

// âœ… SOLUÃ‡ÃƒO: Trigger automÃ¡tico
UPDATE canal_stats SET roi_percentage = novo_calculo
WHERE canal_id = X;
```

---

### 6. âš™ï¸ **Status de IntegraÃ§Ã£o Telegram**

#### **DADOS SINCRONIZADOS:**
- Status do canal Telegram
- ID do canal
- Link de acesso
- SincronizaÃ§Ã£o de membros

#### **ONDE APARECEM:**
- **Tipster**: `/meus-canais` (status dos canais)
- **Admin**: `/admin/canais` (saÃºde da integraÃ§Ã£o)
- **Cliente**: `/dashboard` (link de acesso)

**CENÃRIO CRÃTICO:**
```tsx
// Canal Telegram Ã© deletado manualmente
// âŒ Sistema ainda mostra como "Sincronizado"
// âŒ Novos assinantes nÃ£o conseguem acessar
// âŒ Links ficam quebrados

// âœ… SOLUÃ‡ÃƒO: Health check periÃ³dico
// Job verifica se canal existe no Telegram
// Atualiza telegram_sync_status automaticamente
```

---

## ğŸš¨ **MATRIZ DE SINCRONIZAÃ‡ÃƒO CRÃTICA**

### **NÃVEL 1 - CRÃTICO (Quebra funcionalidade)**

| Dado | Fonte da Verdade | PÃ¡ginas Afetadas | FrequÃªncia |
|------|------------------|------------------|------------|
| **Status Assinatura** | `assinaturas.status` | 5 pÃ¡ginas | Tempo Real |
| **ROI Canal** | `canal_stats.roi_percentage` | 7 pÃ¡ginas | Por mudanÃ§a |
| **Assinantes Ativos** | `COUNT(assinaturas)` | 6 pÃ¡ginas | Tempo Real |
| **Telegram Sync** | `canais.telegram_sync_status` | 4 pÃ¡ginas | 5 min |

### **NÃVEL 2 - IMPORTANTE (InconsistÃªncia)**

| Dado | Fonte da Verdade | PÃ¡ginas Afetadas | FrequÃªncia |
|------|------------------|------------------|------------|
| **PreÃ§o Canal** | `canais.preco_mensal` | 4 pÃ¡ginas | Manual |
| **Lucro Apostas** | `apostas.lucro_calculado` | 3 pÃ¡ginas | Por status |
| **Data Vencimento** | `assinaturas.data_vencimento` | 3 pÃ¡ginas | DiÃ¡rio |

---

## ğŸ”§ **SOLUÃ‡Ã•ES TÃ‰CNICAS OBRIGATÃ“RIAS**

### **1. Views Centralizadas**
```sql
-- Fonte Ãºnica da verdade para mÃ©tricas
CREATE VIEW canal_stats AS
SELECT 
    canal_id,
    COUNT(*) FILTER (WHERE status = 'ativa') as assinantes_ativos,
    SUM(lucro_calculado) / SUM(stake) * 100 as roi_percentage,
    -- etc
FROM assinaturas a
JOIN apostas ap ON a.canal_id = ap.canal_id
GROUP BY canal_id;
```

### **2. Triggers AutomÃ¡ticos**
```sql
-- Recalcula mÃ©tricas quando apostas mudam
CREATE TRIGGER update_canal_stats 
AFTER UPDATE ON apostas
FOR EACH ROW EXECUTE FUNCTION recalculate_canal_metrics();
```

### **3. Cache Inteligente**
```tsx
// Cache com invalidaÃ§Ã£o automÃ¡tica
const useCanalStats = (canalId) => {
  return useSWR(`/api/canal-stats/${canalId}`, {
    refreshInterval: 300000, // 5 min
    revalidateOnFocus: true
  });
};
```

### **4. Estado Global (React)**
```tsx
// Estado global para dados sincronizados
const useSyncedData = () => {
  const [canalStats, setCanalStats] = useGlobalState('canal-stats');
  
  const updateCanalStat = (canalId, newStats) => {
    // Atualiza em todas as pÃ¡ginas simultaneamente
    setCanalStats(prev => ({
      ...prev,
      [canalId]: newStats
    }));
  };
};
```

### **5. WebSockets para Tempo Real**
```tsx
// AtualizaÃ§Ãµes em tempo real para dados crÃ­ticos
useEffect(() => {
  const subscription = supabase
    .channel('canal-updates')
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: 'assinaturas'
    }, (payload) => {
      // Atualiza todas as pÃ¡ginas abertas
      updateCanalStats(payload.new.canal_id);
    })
    .subscribe();
}, []);
```

---

## ğŸ“‹ **CHECKLIST DE VALIDAÃ‡ÃƒO**

### **Para Cada Dado Sincronizado:**

- [ ] **Fonte Ãºnica** da verdade definida
- [ ] **Trigger automÃ¡tico** para recÃ¡lculo
- [ ] **Cache** com invalidaÃ§Ã£o inteligente
- [ ] **Teste** de consistÃªncia entre pÃ¡ginas
- [ ] **Fallback** para quando dados estÃ£o dessincronizados
- [ ] **Monitoramento** de inconsistÃªncias

### **Testes ObrigatÃ³rios:**

- [ ] Mudar status de aposta â†’ Verificar ROI em todas as telas
- [ ] Cancelar assinatura â†’ Verificar contadores em todas as telas  
- [ ] Novo cliente â†’ Verificar vagas disponÃ­veis em tempo real
- [ ] Canal Telegram off â†’ Verificar status em admin e tipster

---

## ğŸ¯ **PRIORIDADE DE IMPLEMENTAÃ‡ÃƒO**

1. **Views `canal_stats`** (fonte Ãºnica de mÃ©tricas)
2. **Triggers automÃ¡ticos** (recÃ¡lculo em tempo real)
3. **Cache inteligente** (performance + consistÃªncia)
4. **Testes de sincronizaÃ§Ã£o** (validaÃ§Ã£o contÃ­nua)
5. **Monitoramento** (alertas para inconsistÃªncias)

**Qual aspecto da sincronizaÃ§Ã£o vocÃª quer detalhar primeiro?**